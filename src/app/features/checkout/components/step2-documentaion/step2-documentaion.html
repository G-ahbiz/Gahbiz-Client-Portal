<div class="checkout-container container py-md-5" *ngIf="step === 2">
  <h2 class="text-left fw-semibold mb-5 mb-md-5">{{ 'checkout.documentations' | translate }}</h2>

  <!-- Loading State -->
  <div *ngIf="orderLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
    </div>
    <p class="mt-3">Loading order details...</p>
  </div>

  <!-- No Services Found -->
  <div *ngIf="!orderLoading && orderItems.length === 0" class="alert alert-warning text-center">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ 'checkout.no-services-found' | translate }}
  </div>

  <div class="row g-4 g-lg-5 justify-content-center" *ngIf="!orderLoading && orderItems.length > 0">
    <!-- Service Data Collection Forms -->
    <div class="col-12">
      <div *ngFor="let service of orderItems; let serviceIndex = index" class="card shadow-sm mb-4 service-data-card">

        <!-- Header (collapsible toggle) -->
        <div class="card-header d-flex justify-content-between align-items-center" (click)="toggleService(serviceIndex)"
          [class.disabled]="serviceSubmitted[serviceIndex]">
          <h4 class="service-title m-0">
            <i class="bi bi-file-earmark-text me-2"></i>
            {{ service.itemName }}
          </h4>
          <i class="bi" [ngClass]="{
           'bi-chevron-down': !expandedStates[serviceIndex],
           'bi-chevron-up': expandedStates[serviceIndex]
         }"></i>
        </div>

        <!-- Collapsible Body -->
        <div class="collapse-wrapper" [class.show]="expandedStates[serviceIndex]">
          <div class="card-body px-4 px-md-5">
            <form [formGroup]="serviceDataForms[serviceIndex]" novalidate>
              <!-- Inputs and Selects Section -->
              <div class="row g-4 mb-4">
                <!-- Row 1: Full Name - SSN/ITIN -->
                <div class="row g-3">
                  <div class="col-6">
                    <app-input formControlName="fullName" id="fullName{{serviceIndex}}"
                      [label]="'checkout.full-name' | translate" [placeholder]="'checkout.enter-full-name' | translate"
                      [isInvalid]="isServiceFieldInvalid(serviceIndex, 'fullName')"
                      [errorMessage]="getServiceFieldError(serviceIndex, 'fullName')"
                      [asteriskColorDanger]="'text-danger'">
                    </app-input>
                  </div>

                  <div class="col-6">
                    <app-input formControlName="ssn" id="ssn{{serviceIndex}}" [label]="'checkout.ssn-itin' | translate"
                      [placeholder]="'checkout.enter-ssn-itin' | translate"
                      [isInvalid]="isServiceFieldInvalid(serviceIndex, 'ssn')"
                      [errorMessage]="getServiceFieldError(serviceIndex, 'ssn')">
                    </app-input>
                  </div>
                </div>

                <!-- Row 2: Business Name - EIN -->
                <div class="row g-3 mt-3">
                  <div class="col-6">
                    <app-input formControlName="businessName" id="businessName{{serviceIndex}}"
                      [label]="'checkout.business-name' | translate"
                      [placeholder]="'checkout.enter-business-name' | translate"
                      [isInvalid]="isServiceFieldInvalid(serviceIndex, 'businessName')"
                      [errorMessage]="getServiceFieldError(serviceIndex, 'businessName')">
                    </app-input>
                  </div>

                  <div class="col-6">
                    <app-input formControlName="ein" id="ein{{serviceIndex}}" [label]="'checkout.ein' | translate"
                      [placeholder]="'checkout.enter-ein' | translate"
                      [isInvalid]="isServiceFieldInvalid(serviceIndex, 'ein')"
                      [errorMessage]="getServiceFieldError(serviceIndex, 'ein')">
                    </app-input>
                  </div>
                </div>

                <!-- Row 3: Business Type - Tax Year (kept as selects) -->
                <div class="row g-3 mt-3">
                  <div class="col-6">
                    <label for="businessType{{serviceIndex}}" class="form-label">{{ 'checkout.business-type' | translate
                      }}</label>
                    <select id="businessType{{serviceIndex}}" class="form-control" formControlName="businessType"
                      [class.is-invalid]="isServiceFieldInvalid(serviceIndex, 'businessType')">
                      <option value="">{{ 'checkout.select-business-type' | translate }}</option>
                      <option value="sole-proprietorship">{{ 'checkout.sole-proprietorship' | translate }}</option>
                      <option value="partnership">{{ 'checkout.partnership' | translate }}</option>
                      <option value="corporation">{{ 'checkout.corporation' | translate }}</option>
                      <option value="llc">{{ 'checkout.llc' | translate }}</option>
                    </select>
                    <div *ngIf="isServiceFieldInvalid(serviceIndex, 'businessType')"
                      class="invalid-feedback d-block mt-1">
                      {{ getServiceFieldError(serviceIndex, 'businessType') }}
                    </div>
                  </div>
                  <div class="col-6">
                    <label for="taxYear{{serviceIndex}}" class="form-label">{{ 'checkout.tax-year' | translate
                      }}</label>
                    <select id="taxYear{{serviceIndex}}" class="form-control" formControlName="taxYear"
                      [class.is-invalid]="isServiceFieldInvalid(serviceIndex, 'taxYear')">
                      <option value="">{{ 'checkout.select-tax-year' | translate }}</option>
                      <option value="2023">2023</option>
                      <option value="2022">2022</option>
                      <option value="2021">2021</option>
                      <option value="2020">2020</option>
                    </select>
                    <div *ngIf="isServiceFieldInvalid(serviceIndex, 'taxYear')" class="invalid-feedback d-block mt-1">
                      {{ getServiceFieldError(serviceIndex, 'taxYear') }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Dynamic File Uploads Section -->
              <div class="file-uploads-section mt-4 pt-4">

                <div class="row g-4">
                  <!-- Dynamic Required Files -->
                  <div *ngFor="let requiredFile of getRequiredFilesForService(serviceIndex); let i = index"
                    [class]="i % 2 === 0 ? 'col-md-6' : 'col-md-6'">
                    <div class="mb-4">
                      <label [for]="'file_' + serviceIndex + '_' + requiredFile.id"
                        class="form-label file-upload-label-fix">
                        {{ requiredFile.name }}
                        <span class="text-danger">*</span>
                      </label>

                      <div class="file-upload-container"
                        [class.has-file]="serviceDataForms[serviceIndex].get(getFileFieldName(requiredFile))?.value">
                        <input type="file" [id]="'file_' + serviceIndex + '_' + requiredFile.id"
                          class="form-control file-input" [accept]="requiredFile.accept || 'image/*,.pdf'"
                          (change)="onFileSelected($event, serviceIndex, getFileFieldName(requiredFile), requiredFile)"
                          #fileInput>

                        <!-- File Preview -->
                        <div class="file-upload-preview"
                          *ngIf="serviceDataForms[serviceIndex].get(getFileFieldName(requiredFile))?.value">
                          <div class="preview-info">
                            <i class="bi bi-file-earmark-text"></i>
                            <span class="file-name">
                              {{ getFileName(serviceDataForms[serviceIndex].get(getFileFieldName(requiredFile))?.value)
                              }}
                            </span>
                            <button type="button" class="btn-remove"
                              (click)="removeFile(serviceIndex, getFileFieldName(requiredFile), fileInput)">
                              <i class="bi bi-x"></i>
                            </button>
                          </div>
                        </div>

                        <!-- Upload Placeholder -->
                        <div class="file-upload-placeholder">
                          <i class="bi bi-file-earmark-arrow-up"></i>
                          <span class="upload-text">
                            {{ 'COMMON.drag-and-drop-or' | translate }}
                            <span class="browse">{{ 'COMMON.browse' | translate }}</span>
                          </span>
                          <!-- Show accepted file types from API -->
                          <span class="upload-subtext" *ngIf="requiredFile.accept">
                            Accepts: {{ requiredFile.accept }}
                          </span>
                          <span class="upload-subtext" *ngIf="requiredFile.description">
                            {{ requiredFile.description }}
                          </span>
                        </div>
                      </div>

                      <div *ngIf="isServiceFieldInvalid(serviceIndex, getFileFieldName(requiredFile))"
                        class="invalid-feedback d-block mt-1">
                        {{ getServiceFieldError(serviceIndex, getFileFieldName(requiredFile)) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg px-4"
                  [disabled]="loading || !serviceDataForms[serviceIndex].valid || serviceSubmitted[serviceIndex]"
                  (click)="submitServiceData(serviceIndex)">
                  <span *ngIf="!loading">{{ 'checkout.submit-service-data' | translate }}</span>
                  <span *ngIf="loading">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    {{ 'checkout.processing' | translate }}
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>